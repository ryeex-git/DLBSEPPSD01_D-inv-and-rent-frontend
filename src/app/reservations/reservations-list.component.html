<div class="filters">
  <mat-form-field appearance="fill">
    <mat-label>Suche</mat-label>
    <input matInput [(ngModel)]="filters.search" (keyup.enter)="applyFilters()" placeholder="Item, Nutzer, Notiz">
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Status</mat-label>
    <mat-select [(ngModel)]="filters.status" (selectionChange)="applyFilters()">
      <mat-option [value]="''">Alle</mat-option>
      <mat-option value="PENDING">Ausstehend</mat-option>
      <mat-option value="APPROVED">Genehmigt</mat-option>
      <mat-option value="CANCELLED">Storniert</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Von</mat-label>
    <input matInput type="date" [(ngModel)]="filters.from" (change)="applyFilters()">
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Bis</mat-label>
    <input matInput type="date" [(ngModel)]="filters.to" (change)="applyFilters()">
  </mat-form-field>

  <span class="spacer"></span>
  <button mat-button (click)="resetFilters()">Zurücksetzen</button>
</div>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1">
  <!-- Zeitraum -->
  <ng-container matColumnDef="period">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Zeitraum</th>
    <td mat-cell *matCellDef="let r">
      {{ fmtDate(r.startAt) }} – {{ fmtDate(r.endAt) }}
    </td>
  </ng-container>

  <!-- Item -->
  <ng-container matColumnDef="item">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Gegenstand</th>
    <td mat-cell *matCellDef="let r">
      {{ r.itemName }} <span class="muted">#{{ r.inventoryNo }}</span>
    </td>
  </ng-container>

  <!-- User -->
  <ng-container matColumnDef="user">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Person</th>
    <td mat-cell *matCellDef="let r">{{ r.userName || '—' }}</td>
  </ng-container>

  <!-- Status -->
  <ng-container matColumnDef="status">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
    <td mat-cell *matCellDef="let r">
      <span class="chip" [class.approved]="r.status==='APPROVED'"
                        [class.pending]="r.status==='PENDING'"
                        [class.cancelled]="r.status==='CANCELLED'">{{ r.status }}</span>
    </td>
  </ng-container>

  <!-- Notiz -->
  <ng-container matColumnDef="note">
    <th mat-header-cell *matHeaderCellDef>Notiz</th>
    <td mat-cell *matCellDef="let r">{{ r.note || '—' }}</td>
  </ng-container>

  <!-- Aktionen -->
  <ng-container matColumnDef="actions">
    <th mat-header-cell *matHeaderCellDef></th>
    <td mat-cell *matCellDef="let r" class="actions">
      <button mat-stroked-button color="primary" *ngIf="isAdmin && r.status==='PENDING'" (click)="approve(r)">
        <mat-icon>check</mat-icon> Genehmigen
      </button>
      <button mat-stroked-button color="warn" *ngIf="isAdmin && r.status!=='CANCELLED'" (click)="cancel(r)">
        <mat-icon>cancel</mat-icon> Stornieren
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</table>

<mat-paginator [length]="total" [pageSize]="pageSize" [pageSizeOptions]="[5,10,25]"></mat-paginator>
